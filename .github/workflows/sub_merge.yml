name: sub_merge

on:
  workflow_dispatch:

  schedule:
    - cron: "0 0/6 * * *"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: emigrate code
        uses: actions/checkout@v3
      - name: install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"
          check-latest: true

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: load cache
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/run_in_Actions/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: set timezone
        run: sudo timedatectl set-timezone 'Asia/Shanghai'

      - name: Save current directory
        run: echo "CURRENT_DIR=$(pwd)" >> $GITHUB_ENV

      - name: install dependencies
        run: |
          pip install -r ./requirements.txt
      - name: Download GeoLite2-Country.mmdb.gz
        run: |
          curl -sSLO https://raw.githubusercontent.com/wp-statistics/GeoLite2-Country/master/GeoLite2-Country.mmdb.gz
          gzip -df GeoLite2-Country.mmdb.gz
      - name: run
        run: |
          rm -rf ./sub/*
          wget -O subconverter.tar.gz https://github.com/tindy2013/subconverter/releases/latest/download/subconverter_linux64.tar.gz
          tar -zxvf subconverter.tar.gz -C ./
          chmod +x ./subconverter/subconverter && nohup ./subconverter/subconverter >./subconverter.log 2>&1 &
          python ./url_update.py
          python ./gen_yaml.py

      - name: Go Cache Modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: go-mod-${{ hashFiles('**/go.sum') }}
          restore-keys: go-mod-${{ hashFiles('**/go.sum') }}

      # å®‰è£…rust cargoçŽ¯å¢ƒ
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      # å®‰è£…https://github.com/yuan2pro/mihomo-speedtest-rs
      - name: Install mihomo-speedtest-rs
        run: |
          cd ${{ env.CURRENT_DIR }}
          cargo install --git https://github.com/yuan2pro/mihomo-speedtest-rs.git --locked    
        
      # å®‰è£…mihomoçš„Alphaåˆ†æ”¯
      - name: Install mihomo
        run: |
          git clone https://github.com/MetaCubeX/mihomo.git -b Alpha
          cd mihomo && go build
          chmod +x mihomo
          # å°†æž„å»ºçš„mihomoäºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶åˆ°ç³»ç»ŸPATHä¸­
          sudo cp mihomo /usr/local/bin/
      
      # ç­›é€‰èŠ‚ç‚¹ï¼šä½¿ç”¨mihomo_test.pyè¿›è¡Œå»¶è¿Ÿæµ‹è¯•å’Œç­›é€‰
      - name: filter nodes with mihomo
        run: |
          cd ${{ env.CURRENT_DIR }}
          # å¾ªçŽ¯éåŽ†subç›®å½•ä¸‹çš„æ‰€æœ‰yamlæ–‡ä»¶
          for file in ${{ env.CURRENT_DIR }}/sub/*.yaml; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "Processing $filename..."

              # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºŽmihomoé…ç½®
              temp_dir=$(mktemp -d)
              config_file="$temp_dir/config.yaml"

              # å¤åˆ¶åŽŸé…ç½®æ–‡ä»¶å¹¶æ·»åŠ APIé…ç½®
              cp "$file" "$config_file"
              # æ·»åŠ mihomo APIé…ç½®
              echo "" >> "$config_file"
              echo "# APIé…ç½®" >> "$config_file"
              echo "external-controller: 127.0.0.1:9090" >> "$config_file"
              echo "external-ui: ui" >> "$config_file"
              echo "secret: test123" >> "$config_file"

              # å¯åŠ¨mihomo
              mihomo -f "$config_file" > /dev/null 2>&1 &
              mihomo_pid=$!
              echo "Started mihomo with PID: $mihomo_pid"

              # ç­‰å¾…mihomoå¯åŠ¨
              sleep 3

              # åˆ›å»ºç­›é€‰åŽçš„é…ç½®æ–‡ä»¶
              output_file="${{ env.CURRENT_DIR }}/sub/${filename%.yaml}_filtered.yaml"

              # è°ƒç”¨mihomo_test.pyè¿›è¡Œç­›é€‰ï¼Œä½¿ç”¨åŽŸå§‹æ–‡ä»¶ä½œä¸ºè¾“å…¥
              if python3 ./mihomo_test.py "$file" "$output_file" \
                  --api-url "http://127.0.0.1:9090" \
                  --max-delay 5000 \
                  --timeout 15 \
                  --test-url "https://www.gstatic.com/generate_204"; then
                echo "Successfully filtered $filename"
              fi

              # åœæ­¢mihomo
              kill $mihomo_pid 2>/dev/null || true
              wait $mihomo_pid 2>/dev/null || true

              # æ¸…ç†ä¸´æ—¶ç›®å½•
              rm -rf "$temp_dir"

              # åˆ é™¤åŽŸæ–‡ä»¶
              rm -f "$file"
              echo "Completed processing $filename"
            fi
          done

          # è¾“å‡ºç­›é€‰ç»Ÿè®¡ä¿¡æ¯
          echo "::group::Filter Statistics"
          total_files=$(ls ${{ env.CURRENT_DIR }}/sub/*_filtered.yaml 2>/dev/null | wc -l)
          total_proxies=0
          for filtered_file in ${{ env.CURRENT_DIR }}/sub/*_filtered.yaml; do
            if [ -f "$filtered_file" ]; then
              proxy_count=$(python3 -c "import yaml; print(len(yaml.safe_load(open('$filtered_file'))['proxies']))" 2>/dev/null || echo "0")
              total_proxies=$((total_proxies + proxy_count))
              filename=$(basename "$filtered_file")
              echo "$filename: $proxy_count proxies"
            fi
          done
          echo "Total filtered files: $total_files"
          echo "Total remaining proxies: $total_proxies"
          echo "::endgroup::"

      - name: merge nodes
        run: |
          python ./merge.py
      
      - name: Checkout clash2singbox repository
        uses: actions/checkout@v2
        with:
          repository: yuan2pro/clash2singbox  # æ›¿æ¢ä¸ºç›®æ ‡ä»“åº“çš„æ‰€æœ‰è€…å’Œä»“åº“å
          path: ./clash2singbox  # ä¸‹è½½åˆ°å½“å‰ç›®å½•

      - name: List files in current directory
        run: |
          ls  # åˆ—å‡ºå½“å‰ç›®å½•ä¸­çš„æ–‡ä»¶
          ls sub
        

      - name: Build Go program
        run: |
          cd ./clash2singbox
          go mod tidy || true
          cp -f ${{ env.CURRENT_DIR }}/singbox.json ./config.json.template || true
          if ! go build -o clash2singbox ./main.go; then
            echo "æž„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
            exit 0
          fi
          
          for file in ${{ env.CURRENT_DIR }}/sub/*.yaml; do
            filename=$(basename "$file")
            if ./clash2singbox -i "$file" -o "${{ env.CURRENT_DIR }}/sub/${filename%.yaml}.json"; then
              echo "Successfully converted ${filename}"
            else
              echo "Failed to convert ${filename}, skipping..."
              continue
            fi
          done || true

      - name: commit
        run: |
          cd ${{ env.CURRENT_DIR }}
          Emoji=("ðŸŽ‰" "ðŸ¤ž" "âœ¨" "ðŸŽ" "ðŸŽˆ" "ðŸŽ„" "ðŸŽ¨" "ðŸ’‹" "ðŸ“" "ðŸ•" "ðŸ‰" "ðŸ’" "ðŸŒ´" "ðŸš€" "ðŸ›¸" "ðŸ—½" "â›…" "ðŸŒˆ" "ðŸ”¥" "â›„" "ðŸ¶" "ðŸ…" "ðŸ¦„" "ðŸ¤")
          MSG="${Emoji[$[$RANDOM % ${#Emoji[@]}]]} UPDATE TIME: $(date +%Y-%m-%d" "%H:%M:%S)"
          echo $MSG > README.md
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add -f ./sub
          git add -f ./sub_list.json
          git add -f ./README.md
          git commit -m "$MSG"

      - name: push
        uses: ad-m/github-push-action@master
        with:
          # github_token: ${{ secrets.TOKEN }}
          branch: main
